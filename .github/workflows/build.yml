name: Build All Versions

on:
  push:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - mc: "1.21"
            yarn: "1.21+build.9"
            loader: "0.16.0"
            fabric_api: "0.100.8+1.21"
          - mc: "1.21.1"
            yarn: "1.21.1+build.3"
            loader: "0.16.0"
            fabric_api: "0.102.0+1.21.1"
          - mc: "1.21.2"
            yarn: "1.21.2+build.1"
            loader: "0.16.5"
            fabric_api: "0.105.0+1.21.2"
          - mc: "1.21.3"
            yarn: "1.21.3+build.2"
            loader: "0.16.7"
            fabric_api: "0.106.1+1.21.3"
          - mc: "1.21.4"
            yarn: "1.21.4+build.8"
            loader: "0.16.9"
            fabric_api: "0.110.0+1.21.4"
          - mc: "1.21.5"
            yarn: "1.21.5+build.1"
            loader: "0.16.10"
            fabric_api: "0.119.2+1.21.5"
          - mc: "1.21.6"
            yarn: "1.21.6+build.1"
            loader: "0.16.10"
            fabric_api: "0.119.5+1.21.6"
          - mc: "1.21.7"
            yarn: "1.21.7+build.1"
            loader: "0.18.0"
            fabric_api: "0.127.0+1.21.7"
          - mc: "1.21.8"
            yarn: "1.21.8+build.1"
            loader: "0.18.1"
            fabric_api: "0.130.0+1.21.8"
          - mc: "1.21.9"
            yarn: "1.21.9+build.1"
            loader: "0.18.2"
            fabric_api: "0.132.0+1.21.9"
          - mc: "1.21.10"
            yarn: "1.21.10+build.1"
            loader: "0.18.3"
            fabric_api: "0.136.0+1.21.10"
          - mc: "1.21.11"
            yarn: "1.21.11+build.4"
            loader: "0.18.4"
            fabric_api: "0.141.3+1.21.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle & Loom
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ matrix.mc }}-${{ hashFiles('build.gradle', 'gradle.properties') }}
          restore-keys: |
            gradle-${{ matrix.mc }}-
            gradle-

      - name: Patch gradle.properties for ${{ matrix.mc }}
        run: |
          sed -i "s|^minecraft_version=.*|minecraft_version=${{ matrix.mc }}|" gradle.properties
          sed -i "s|^yarn_mappings=.*|yarn_mappings=${{ matrix.yarn }}|" gradle.properties
          sed -i "s|^loader_version=.*|loader_version=${{ matrix.loader }}|" gradle.properties
          sed -i "s|^fabric_version=.*|fabric_version=${{ matrix.fabric_api }}|" gradle.properties

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew build --no-daemon --stacktrace

      - name: Rename JAR
        run: |
          mkdir -p artifacts
          for jar in build/libs/*[0-9].jar; do
            [ -f "$jar" ] || continue
            cp "$jar" "artifacts/inventoryscale-mc${{ matrix.mc }}.jar"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: inventoryscale-mc${{ matrix.mc }}
          path: artifacts/*.jar
          retention-days: 90
