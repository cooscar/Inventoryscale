name: Build All Versions

on:
  push:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - mc: "1.21.9"
            yarn: "1.21.9+build.1"
            loader: "0.18.2"
            fabric_api: "0.130.0+1.21.9"
          - mc: "1.21.10"
            yarn: "1.21.10+build.1"
            loader: "0.18.3"
            fabric_api: "0.134.1+1.21.10"
          - mc: "1.21.11"
            yarn: "1.21.11+build.4"
            loader: "0.18.4"
            fabric_api: "0.141.3+1.21.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download Gradle wrapper jar
        run: |
          mkdir -p gradle/wrapper
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            https://github.com/gradle/gradle/raw/v9.2.1/gradle/wrapper/gradle-wrapper.jar

      - name: Cache Gradle & Loom
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ matrix.mc }}-${{ hashFiles('build.gradle', 'gradle.properties') }}
          restore-keys: |
            gradle-${{ matrix.mc }}-
            gradle-

      - name: Patch gradle.properties for ${{ matrix.mc }}
        run: |
          sed -i "s|^minecraft_version=.*|minecraft_version=${{ matrix.mc }}|" gradle.properties
          sed -i "s|^yarn_mappings=.*|yarn_mappings=${{ matrix.yarn }}|" gradle.properties
          sed -i "s|^loader_version=.*|loader_version=${{ matrix.loader }}|" gradle.properties
          sed -i "s|^fabric_version=.*|fabric_version=${{ matrix.fabric_api }}|" gradle.properties

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew build --no-daemon --stacktrace

      - name: Rename JAR
        run: |
          mkdir -p artifacts
          for jar in build/libs/*[0-9].jar; do
            [ -f "$jar" ] || continue
            cp "$jar" "artifacts/inventoryscale-mc${{ matrix.mc }}.jar"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: inventoryscale-mc${{ matrix.mc }}
          path: artifacts/*.jar
          retention-days: 90
