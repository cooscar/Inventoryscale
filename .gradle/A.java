plugins {
    id 'fabric-loom' version '1.15-SNAPSHOT'
    id 'maven-publish'
}

version = project.mod_version
group = project.maven_group

base {
    archivesName = project.archives_base_name
}

loom {
    splitEnvironmentSourceSets()

    mods {
        "inventoryscale" {
            sourceSet sourceSets.main
            sourceSet sourceSets.client
        }
    }
}

fabricApi {
    configureDataGeneration {
        client = true
    }
}

repositories {
}

dependencies {
    minecraft "com.mojang:minecraft:${project.minecraft_version}"
    mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
    modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"
    modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
}

processResources {
    inputs.property "version", project.version
    inputs.property "minecraft_version", project.minecraft_version
    inputs.property "loader_version", project.loader_version
    filteringCharset "UTF-8"

    filesMatching("fabric.mod.json") {
        expand "version": project.version,
                "minecraft_version": project.minecraft_version,
                "loader_version": project.loader_version
    }
}

// ── CategoryHelper generation ─────────────────────────────────────────────────
// In 1.21.9+ the KeyBinding constructor no longer accepts a plain String for the
// category parameter; it requires a KeyBinding.Category object instead.
// We detect the version at Gradle configuration time and generate a tiny helper
// class with the correct return type so the same Java source compiles on all
// supported Minecraft versions.

def mcParts        = minecraft_version.tokenize('.')
def mcMinor        = mcParts.size() > 1 ? mcParts[1].toInteger() : 0
def mcPatch        = mcParts.size() > 2 ? mcParts[2].toInteger() : 0
def useNewCatApi   = (mcMinor > 21) || (mcMinor == 21 && mcPatch >= 9)

def generatedDir   = file("${buildDir}/generated/sources/categoryHelper")

// Wire the generated directory into the *client* source set
sourceSets.client.java.srcDir generatedDir

task generateCategoryHelper {
    description = "Generates CategoryHelper.java with the correct KeyBinding category API."
    outputs.dir generatedDir

    doFirst {
        def pkg = file("${generatedDir}/optimal/inventoryscale/client")
        pkg.mkdirs()
        def out = new File(pkg, "CategoryHelper.java")

        if (useNewCatApi) {
            // 1.21.9+ – category is a KeyBinding.Category object
            out.text = """\
package optimal.inventoryscale.client;

import net.minecraft.client.option.KeyBinding;
import net.minecraft.util.Identifier;

/** Auto-generated by build.gradle – do not edit. */
public final class CategoryHelper {
    private CategoryHelper() {}

    public static KeyBinding.Category getMiscCategory() {
        return KeyBinding.Category.create(Identifier.of("inventoryscale", "misc"));
    }
}
"""
        } else {
            // pre-1.21.9 – category is a plain String
            out.text = """\
package optimal.inventoryscale.client;

/** Auto-generated by build.gradle – do not edit. */
public final class CategoryHelper {
    private CategoryHelper() {}

    public static String getMiscCategory() {
        return "key.categories.misc";
    }
}
"""
        }
    }
}

// Make sure the helper is generated before any Java compilation happens
compileClientJava.dependsOn generateCategoryHelper
// Also needed when Loom remaps sources
tasks.matching { it.name == "remapSourcesJar" }.configureEach {
    dependsOn generateCategoryHelper
}
// ─────────────────────────────────────────────────────────────────────────────

def targetJavaVersion = 21
tasks.withType(JavaCompile).configureEach {
    it.options.encoding = "UTF-8"
    if (targetJavaVersion >= 10 || JavaVersion.current().isJava10Compatible()) {
        it.options.release.set(targetJavaVersion)
    }
}

java {
    def javaVersion = JavaVersion.toVersion(targetJavaVersion)
    if (JavaVersion.current() < javaVersion) {
        toolchain.languageVersion = JavaLanguageVersion.of(targetJavaVersion)
    }
    withSourcesJar()
}

jar {
    from("LICENSE") {
        rename { "${it}_${project.archives_base_name}" }
    }
}

publishing {
    publications {
        create("mavenJava", MavenPublication) {
            artifactId = project.archives_base_name
            from components.java
        }
    }
    repositories {}
}